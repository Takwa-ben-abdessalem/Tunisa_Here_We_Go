import { Component, Input, ViewChild, EventEmitter, Output } from '@angular/core';
import { from } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "../services/stripe-elements.service";
export class StripePaymentRequestButtonComponent {
    constructor(stripeElementsService) {
        this.stripeElementsService = stripeElementsService;
        this.load = new EventEmitter();
        this.change = new EventEmitter();
        this.blur = new EventEmitter();
        this.focus = new EventEmitter();
        this.ready = new EventEmitter();
        this.token = new EventEmitter();
        this.paymentMethod = new EventEmitter();
        this.source = new EventEmitter();
        this.cancel = new EventEmitter();
        this.shippingaddresschange = new EventEmitter();
        this.shippingoptionchange = new EventEmitter();
        this.notavailable = new EventEmitter();
    }
    async ngOnChanges(changes) {
        const options = this.stripeElementsService.mergeOptions(this.options, this.containerClass);
        const elementsOptions = this.elementsOptions;
        const stripe = this.stripe;
        let updateElements = false;
        if (changes.elementsOptions || changes.stripe || !this.elements) {
            const elements = await this.stripeElementsService.elements(stripe, elementsOptions).toPromise();
            this.elements = elements;
            updateElements = true;
        }
        if (changes.paymentOptions && this.paymentRequest) {
            this.updateRequest(this.paymentOptions);
        }
        if (changes.options || changes.containerClass || !this.element || updateElements) {
            if (this.element && !updateElements) {
                this.update(options);
            }
            else if (this.elements && updateElements) {
                this.paymentRequest = this.stripeElementsService.paymentRequest(stripe, this.paymentOptions);
                this.paymentRequest.on('token', (ev) => this.token.emit(ev));
                if (this.paymentMethod.observed)
                    this.paymentRequest.on('paymentmethod', (ev) => this.paymentMethod.emit(ev));
                if (this.source.observed && !this.paymentMethod.observed)
                    this.paymentRequest.on('source', (ev) => this.source.emit(ev));
                this.paymentRequest.on('cancel', () => this.cancel.emit());
                this.paymentRequest.on('shippingaddresschange', (ev) => this.shippingaddresschange.emit(ev));
                this.paymentRequest.on('shippingoptionchange', (ev) => this.shippingoptionchange.emit(ev));
                this.element = this.elements.create('paymentRequestButton', {
                    paymentRequest: this.paymentRequest,
                    ...options
                });
                this.canMakePayment().subscribe((result) => {
                    if (result) {
                        this.element.on('click', (ev) => this.change.emit(ev));
                        this.element.on('blur', () => this.blur.emit());
                        this.element.on('focus', () => this.focus.emit());
                        this.element.on('ready', () => this.ready.emit());
                        this.element.mount(this.stripeElementRef.nativeElement);
                        this.load.emit({
                            paymentRequestButton: this.element,
                            paymentRequest: this.paymentRequest
                        });
                    }
                    else {
                        this.notavailable.emit();
                    }
                });
            }
        }
    }
    canMakePayment() {
        return from(this.paymentRequest.canMakePayment());
    }
    update(options) {
        this.element.update(options);
    }
    updateRequest(options) {
        const { currency, total, displayItems, shippingOptions } = options;
        this.paymentRequest.update({
            currency,
            total,
            displayItems,
            shippingOptions
        });
    }
    show() {
        this.paymentRequest.show();
    }
    /**
     * @deprecated
     */
    getButton() {
        return this.element;
    }
}
StripePaymentRequestButtonComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.8", ngImport: i0, type: StripePaymentRequestButtonComponent, deps: [{ token: i1.StripeElementsService }], target: i0.ɵɵFactoryTarget.Component });
StripePaymentRequestButtonComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.3.8", type: StripePaymentRequestButtonComponent, selector: "ngx-stripe-payment-request-button", inputs: { containerClass: "containerClass", paymentOptions: "paymentOptions", options: "options", elementsOptions: "elementsOptions", stripe: "stripe" }, outputs: { load: "load", change: "change", blur: "blur", focus: "focus", ready: "ready", token: "token", paymentMethod: "paymentMethod", source: "source", cancel: "cancel", shippingaddresschange: "shippingaddresschange", shippingoptionchange: "shippingoptionchange", notavailable: "notavailable" }, viewQueries: [{ propertyName: "stripeElementRef", first: true, predicate: ["stripeElementRef"], descendants: true }], usesOnChanges: true, ngImport: i0, template: `<div class="field" #stripeElementRef></div>`, isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.8", ngImport: i0, type: StripePaymentRequestButtonComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'ngx-stripe-payment-request-button',
                    template: `<div class="field" #stripeElementRef></div>`
                }]
        }], ctorParameters: function () { return [{ type: i1.StripeElementsService }]; }, propDecorators: { stripeElementRef: [{
                type: ViewChild,
                args: ['stripeElementRef']
            }], containerClass: [{
                type: Input
            }], paymentOptions: [{
                type: Input
            }], options: [{
                type: Input
            }], elementsOptions: [{
                type: Input
            }], stripe: [{
                type: Input
            }], load: [{
                type: Output
            }], change: [{
                type: Output
            }], blur: [{
                type: Output
            }], focus: [{
                type: Output
            }], ready: [{
                type: Output
            }], token: [{
                type: Output
            }], paymentMethod: [{
                type: Output
            }], source: [{
                type: Output
            }], cancel: [{
                type: Output
            }], shippingaddresschange: [{
                type: Output
            }], shippingoptionchange: [{
                type: Output
            }], notavailable: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudC1yZXF1ZXN0LWJ1dHRvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc3RyaXBlL3NyYy9saWIvY29tcG9uZW50cy9wYXltZW50LXJlcXVlc3QtYnV0dG9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQWMsWUFBWSxFQUFFLE1BQU0sRUFBNEIsTUFBTSxlQUFlLENBQUM7QUFDeEgsT0FBTyxFQUFjLElBQUksRUFBRSxNQUFNLE1BQU0sQ0FBQzs7O0FBMEJ4QyxNQUFNLE9BQU8sbUNBQW1DO0lBK0I5QyxZQUFtQixxQkFBNEM7UUFBNUMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQXBCckQsU0FBSSxHQUFHLElBQUksWUFBWSxFQUc3QixDQUFDO1FBRUssV0FBTSxHQUFHLElBQUksWUFBWSxFQUErQyxDQUFDO1FBQ3pFLFNBQUksR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBQ2hDLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBQ2pDLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBRWpDLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBNEIsQ0FBQztRQUNyRCxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFvQyxDQUFDO1FBQ3JFLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBNkIsQ0FBQztRQUN2RCxXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUNsQywwQkFBcUIsR0FBRyxJQUFJLFlBQVksRUFBc0MsQ0FBQztRQUMvRSx5QkFBb0IsR0FBRyxJQUFJLFlBQVksRUFBcUMsQ0FBQztRQUM3RSxpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFRLENBQUM7SUFJZ0IsQ0FBQztJQUVuRSxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQXNCO1FBQ3RDLE1BQU0s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QUFxQjtzQkFBOUIsTUFBTTtnQkFDRyxvQkFBb0I7c0JBQTdCLE1BQU07Z0JBQ0csWUFBWTtzQkFBckIsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIFZpZXdDaGlsZCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBPdXRwdXQsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge1xuICBTdHJpcGVFbGVtZW50c09wdGlvbnMsXG4gIFN0cmlwZUVsZW1lbnRzLFxuICBQYXltZW50UmVxdWVzdE9wdGlvbnMsXG4gIFBheW1lbnRSZXF1ZXN0LFxuICBDYW5NYWtlUGF5bWVudFJlc3VsdCxcbiAgUGF5bWVudFJlcXVlc3RVcGRhdGVPcHRpb25zLFxuICBTdHJpcGVQYXltZW50UmVxdWVzdEJ1dHRvbkVsZW1lbnQsXG4gIFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudE9wdGlvbnMsXG4gIFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudENsaWNrRXZlbnQsXG4gIFBheW1lbnRSZXF1ZXN0VG9rZW5FdmVudCxcbiAgUGF5bWVudFJlcXVlc3RQYXltZW50TWV0aG9kRXZlbnQsXG4gIFBheW1lbnRSZXF1ZXN0U291cmNlRXZlbnQsXG4gIFBheW1lbnRSZXF1ZXN0U2hpcHBpbmdBZGRyZXNzRXZlbnQsXG4gIFBheW1lbnRSZXF1ZXN0U2hpcHBpbmdPcHRpb25FdmVudFxufSBmcm9tICdAc3RyaXBlL3N0cmlwZS1qcyc7XG5cbmltcG9ydCB7IFN0cmlwZUluc3RhbmNlIH0gZnJvbSAnLi4vc2VydmljZXMvc3RyaXBlLWluc3RhbmNlLmNsYXNzJztcbmltcG9ydCB7IFN0cmlwZUVsZW1lbnRzU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3N0cmlwZS1lbGVtZW50cy5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmd4LXN0cmlwZS1wYXltZW50LXJlcXVlc3QtYnV0dG9uJyxcbiAgdGVtcGxhdGU6IGA8ZGl2IGNsYXNzPVwiZmllbGRcIiAjc3RyaXBlRWxlbWVudFJlZj48L2Rpdj5gXG59KVxuZXhwb3J0IGNsYXNzIFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uQ29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgQFZpZXdDaGlsZCgnc3RyaXBlRWxlbWVudFJlZicpIHB1YmxpYyBzdHJpcGVFbGVtZW50UmVmITogRWxlbWVudFJlZjtcbiAgZWxlbWVudCE6IFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudDtcbiAgcGF5bWVudFJlcXVlc3QhOiBQYXltZW50UmVxdWVzdDtcblxuICBASW5wdXQoKSBjb250YWluZXJDbGFzczogc3RyaW5nO1xuICBASW5wdXQoKSBwYXltZW50T3B0aW9uczogUGF5bWVudFJlcXVlc3RPcHRpb25zO1xuICBASW5wdXQoKSBvcHRpb25zOiBTdHJpcGVQYXltZW50UmVxdWVzdEJ1dHRvbkVsZW1lbnRPcHRpb25zO1xuICBASW5wdXQoKSBlbGVtZW50c09wdGlvbnM6IFBhcnRpYWw8U3RyaXBlRWxlbWVudHNPcHRpb25zPjtcbiAgQElucHV0KCkgc3RyaXBlOiBTdHJpcGVJbnN0YW5jZTtcblxuICBAT3V0cHV0KCkgbG9hZCA9IG5ldyBFdmVudEVtaXR0ZXI8e1xuICAgIHBheW1lbnRSZXF1ZXN0QnV0dG9uOiBTdHJpcGVQYXltZW50UmVxdWVzdEJ1dHRvbkVsZW1lbnQ7XG4gICAgcGF5bWVudFJlcXVlc3Q6IFBheW1lbnRSZXF1ZXN0O1xuICB9PigpO1xuXG4gIEBPdXRwdXQoKSBjaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudENsaWNrRXZlbnQ+KCk7XG4gIEBPdXRwdXQoKSBibHVyID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICBAT3V0cHV0KCkgZm9jdXMgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIEBPdXRwdXQoKSByZWFkeSA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICBAT3V0cHV0KCkgdG9rZW4gPSBuZXcgRXZlbnRFbWl0dGVyPFBheW1lbnRSZXF1ZXN0VG9rZW5FdmVudD4oKTtcbiAgQE91dHB1dCgpIHBheW1lbnRNZXRob2QgPSBuZXcgRXZlbnRFbWl0dGVyPFBheW1lbnRSZXF1ZXN0UGF5bWVudE1ldGhvZEV2ZW50PigpO1xuICBAT3V0cHV0KCkgc291cmNlID0gbmV3IEV2ZW50RW1pdHRlcjxQYXltZW50UmVxdWVzdFNvdXJjZUV2ZW50PigpO1xuICBAT3V0cHV0KCkgY2FuY2VsID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICBAT3V0cHV0KCkgc2hpcHBpbmdhZGRyZXNzY2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxQYXltZW50UmVxdWVzdFNoaXBwaW5nQWRkcmVzc0V2ZW50PigpO1xuICBAT3V0cHV0KCkgc2hpcHBpbmdvcHRpb25jaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPFBheW1lbnRSZXF1ZXN0U2hpcHBpbmdPcHRpb25FdmVudD4oKTtcbiAgQE91dHB1dCgpIG5vdGF2YWlsYWJsZSA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICBlbGVtZW50czogU3RyaXBlRWxlbWVudHM7XG5cbiAgY29uc3RydWN0b3IocHVibGljIHN0cmlwZUVsZW1lbnRzU2VydmljZTogU3RyaXBlRWxlbWVudHNTZXJ2aWNlKSB7fVxuXG4gIGFzeW5jIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5zdHJpcGVFbGVtZW50c1NlcnZpY2UubWVyZ2VPcHRpb25zKHRoaXMub3B0aW9ucywgdGhpcy5jb250YWluZXJDbGFzcyk7XG4gICAgY29uc3QgZWxlbWVudHNPcHRpb25zID0gdGhpcy5lbGVtZW50c09wdGlvbnM7XG4gICAgY29uc3Qgc3RyaXBlID0gdGhpcy5zdHJpcGU7XG4gICAgbGV0IHVwZGF0ZUVsZW1lbnRzID0gZmFsc2U7XG5cbiAgICBpZiAoY2hhbmdlcy5lbGVtZW50c09wdGlvbnMgfHwgY2hhbmdlcy5zdHJpcGUgfHwgIXRoaXMuZWxlbWVudHMpIHtcbiAgICAgIGNvbnN0IGVsZW1lbnRzID0gYXdhaXQgdGhpcy5zdHJpcGVFbGVtZW50c1NlcnZpY2UuZWxlbWVudHMoc3RyaXBlLCBlbGVtZW50c09wdGlvbnMpLnRvUHJvbWlzZSgpO1xuICAgICAgdGhpcy5lbGVtZW50cyA9IGVsZW1lbnRzO1xuICAgICAgdXBkYXRlRWxlbWVudHMgPSB0cnVlO1xuICAgIH1cblxuICAgIGlmIChjaGFuZ2VzLnBheW1lbnRPcHRpb25zICYmIHRoaXMucGF5bWVudFJlcXVlc3QpIHtcbiAgICAgIHRoaXMudXBkYXRlUmVxdWVzdCh0aGlzLnBheW1lbnRPcHRpb25zKTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcy5vcHRpb25zIHx8IGNoYW5nZXMuY29udGFpbmVyQ2xhc3MgfHwgIXRoaXMuZWxlbWVudCB8fCB1cGRhdGVFbGVtZW50cykge1xuICAgICAgaWYgKHRoaXMuZWxlbWVudCAmJiAhdXBkYXRlRWxlbWVudHMpIHtcbiAgICAgICAgdGhpcy51cGRhdGUob3B0aW9ucyk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuZWxlbWVudHMgJiYgdXBkYXRlRWxlbWVudHMpIHtcbiAgICAgICAgdGhpcy5wYXltZW50UmVxdWVzdCA9IHRoaXMuc3RyaXBlRWxlbWVudHNTZXJ2aWNlLnBheW1lbnRSZXF1ZXN0KHN0cmlwZSwgdGhpcy5wYXltZW50T3B0aW9ucyk7XG4gICAgICAgIHRoaXMucGF5bWVudFJlcXVlc3Qub24oJ3Rva2VuJywgKGV2KSA9PiB0aGlzLnRva2VuLmVtaXQoZXYpKTtcbiAgICAgICAgaWYgKHRoaXMucGF5bWVudE1ldGhvZC5vYnNlcnZlZCkgdGhpcy5wYXltZW50UmVxdWVzdC5vbigncGF5bWVudG1ldGhvZCcsIChldikgPT4gdGhpcy5wYXltZW50TWV0aG9kLmVtaXQoZXYpKTtcbiAgICAgICAgaWYgKHRoaXMuc291cmNlLm9ic2VydmVkICYmICF0aGlzLnBheW1lbnRNZXRob2Qub2JzZXJ2ZWQpIHRoaXMucGF5bWVudFJlcXVlc3Qub24oJ3NvdXJjZScsIChldikgPT4gdGhpcy5zb3VyY2UuZW1pdChldikpO1xuICAgICAgICB0aGlzLnBheW1lbnRSZXF1ZXN0Lm9uKCdjYW5jZWwnLCAoKSA9PiB0aGlzLmNhbmNlbC5lbWl0KCkpO1xuICAgICAgICB0aGlzLnBheW1lbnRSZXF1ZXN0Lm9uKCdzaGlwcGluZ2FkZHJlc3NjaGFuZ2UnLCAoZXYpID0+IHRoaXMuc2hpcHBpbmdhZGRyZXNzY2hhbmdlLmVtaXQoZXYpKTtcbiAgICAgICAgdGhpcy5wYXltZW50UmVxdWVzdC5vbignc2hpcHBpbmdvcHRpb25jaGFuZ2UnLCAoZXYpID0+IHRoaXMuc2hpcHBpbmdvcHRpb25jaGFuZ2UuZW1pdChldikpO1xuICAgICAgICB0aGlzLmVsZW1lbnQgPSB0aGlzLmVsZW1lbnRzLmNyZWF0ZSgncGF5bWVudFJlcXVlc3RCdXR0b24nLCB7XG4gICAgICAgICAgcGF5bWVudFJlcXVlc3Q6IHRoaXMucGF5bWVudFJlcXVlc3QsXG4gICAgICAgICAgLi4ub3B0aW9uc1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNhbk1ha2VQYXltZW50KCkuc3Vic2NyaWJlKChyZXN1bHQpID0+IHtcbiAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQub24oJ2NsaWNrJywgKGV2KSA9PiB0aGlzLmNoYW5nZS5lbWl0KGV2KSk7XG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQub24oJ2JsdXInLCAoKSA9PiB0aGlzLmJsdXIuZW1pdCgpKTtcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5vbignZm9jdXMnLCAoKSA9PiB0aGlzLmZvY3VzLmVtaXQoKSk7XG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQub24oJ3JlYWR5JywgKCkgPT4gdGhpcy5yZWFkeS5lbWl0KCkpO1xuXG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQubW91bnQodGhpcy5zdHJpcGVFbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpO1xuXG4gICAgICAgICAgICB0aGlzLmxvYWQuZW1pdCh7XG4gICAgICAgICAgICAgIHBheW1lbnRSZXF1ZXN0QnV0dG9uOiB0aGlzLmVsZW1lbnQsXG4gICAgICAgICAgICAgIHBheW1lbnRSZXF1ZXN0OiB0aGlzLnBheW1lbnRSZXF1ZXN0XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ub3RhdmFpbGFibGUuZW1pdCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY2FuTWFrZVBheW1lbnQoKTogT2JzZXJ2YWJsZTxDYW5NYWtlUGF5bWVudFJlc3VsdCB8IG51bGw+IHtcbiAgICByZXR1cm4gZnJvbSh0aGlzLnBheW1lbnRSZXF1ZXN0LmNhbk1ha2VQYXltZW50KCkpO1xuICB9XG5cbiAgdXBkYXRlKG9wdGlvbnM6IFBhcnRpYWw8U3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25FbGVtZW50T3B0aW9ucz4pIHtcbiAgICB0aGlzLmVsZW1lbnQudXBkYXRlKG9wdGlvbnMpO1xuICB9XG5cbiAgdXBkYXRlUmVxdWVzdChvcHRpb25zOiBQYXltZW50UmVxdWVzdFVwZGF0ZU9wdGlvbnMpIHtcbiAgICBjb25zdCB7IGN1cnJlbmN5LCB0b3RhbCwgZGlzcGxheUl0ZW1zLCBzaGlwcGluZ09wdGlvbnMgfSA9IG9wdGlvbnM7XG5cbiAgICB0aGlzLnBheW1lbnRSZXF1ZXN0LnVwZGF0ZSh7XG4gICAgICBjdXJyZW5jeSxcbiAgICAgIHRvdGFsLFxuICAgICAgZGlzcGxheUl0ZW1zLFxuICAgICAgc2hpcHBpbmdPcHRpb25zXG4gICAgfSk7XG4gIH1cblxuICBzaG93KCkge1xuICAgIHRoaXMucGF5bWVudFJlcXVlc3Quc2hvdygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBnZXRCdXR0b24oKSB7XG4gICAgcmV0dXJuIHRoaXMuZWxlbWVudDtcbiAgfVxufVxuIl19